<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.1/peerjs.min.js"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .video-container { 
            background: black;
            margin-bottom: 20px;
            position: relative;
        }
        video { width: 100%; height: auto; }
        .controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const App = () => {
            const [isHost, setIsHost] = React.useState(false);
            const [peerId, setPeerId] = React.useState('');
            const [status, setStatus] = React.useState('');
            const [isMuted, setIsMuted] = React.useState(false);
            const [isVideoOff, setIsVideoOff] = React.useState(false);

            const localVideoRef = React.useRef();
            const remoteVideoRef = React.useRef();
            const peerRef = React.useRef(null);
            const streamRef = React.useRef(null);

            React.useEffect(() => {
                // Initialize media stream
                async function setupMedia() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true
                        });
                        streamRef.current = stream;
                        if (localVideoRef.current) {
                            localVideoRef.current.srcObject = stream;
                        }

                        // Initialize PeerJS
                        const peer = new Peer(isHost ? 'host-id' : undefined);
                        
                        peer.on('open', (id) => {
                            setPeerId(id);
                            setStatus(isHost ? 'Host ready. ID: host-id' : `Your ID: ${id}`);
                            peerRef.current = peer;
                        });

                        peer.on('call', (call) => {
                            call.answer(stream);
                            call.on('stream', (remoteStream) => {
                                if (remoteVideoRef.current) {
                                    remoteVideoRef.current.srcObject = remoteStream;
                                }
                            });
                        });

                    } catch (err) {
                        setStatus('Error accessing camera/microphone: ' + err.message);
                    }
                }

                setupMedia();

                // Cleanup
                return () => {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                    if (peerRef.current) {
                        peerRef.current.destroy();
                    }
                };
            }, [isHost]);

            const connectToHost = () => {
                if (!peerRef.current || !streamRef.current) {
                    setStatus('Not ready to connect');
                    return;
                }

                const call = peerRef.current.call('host-id', streamRef.current);
                call.on('stream', (remoteStream) => {
                    if (remoteVideoRef.current) {
                        remoteVideoRef.current.srcObject = remoteStream;
                        setStatus('Connected to host');
                    }
                });
            };

            const toggleMute = () => {
                if (streamRef.current) {
                    const audioTrack = streamRef.current.getAudioTracks()[0];
                    audioTrack.enabled = !audioTrack.enabled;
                    setIsMuted(!audioTrack.enabled);
                }
            };

            const toggleVideo = () => {
                if (streamRef.current) {
                    const videoTrack = streamRef.current.getVideoTracks()[0];
                    videoTrack.enabled = !videoTrack.enabled;
                    setIsVideoOff(!videoTrack.enabled);
                }
            };

            return (
                <div className="container">
                    <div>
                        <button onClick={() => setIsHost(true)} disabled={isHost}>
                            Be Host
                        </button>
                        <button onClick={() => setIsHost(false)} disabled={!isHost}>
                            Be Viewer
                        </button>
                    </div>

                    <div className="status">{status}</div>

                    {!isHost && (
                        <button onClick={connectToHost}>
                            Connect to Host
                        </button>
                    )}

                    <div className="video-container">
                        <video
                            ref={localVideoRef}
                            autoPlay
                            playsInline
                            muted
                        />
                        <div className="controls">
                            <button onClick={toggleMute}>
                                {isMuted ? 'Unmute' : 'Mute'}
                            </button>
                            <button onClick={toggleVideo}>
                                {isVideoOff ? 'Start Video' : 'Stop Video'}
                            </button>
                        </div>
                    </div>

                    <div className="video-container">
                        <video
                            ref={remoteVideoRef}
                            autoPlay
                            playsInline
                        />
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
