<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.1/peerjs.min.js"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .video-container { 
            background: black;
            margin-bottom: 20px;
            position: relative;
        }
        .remote-video {
            width: 100%;
            max-height: 80vh;
        }
        .controls {
            padding: 10px;
            background: #f0f0f0;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background: #f0f0f0;
        }
        .role-selector {
            margin-bottom: 20px;
        }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const App = () => {
            const [isHost, setIsHost] = React.useState(false);
            const [status, setStatus] = React.useState('');
            const [isConnected, setIsConnected] = React.useState(false);
            const [useCamera, setUseCamera] = React.useState(false);

            const localVideoRef = React.useRef();
            const remoteVideoRef = React.useRef();
            const peerRef = React.useRef(null);
            const streamRef = React.useRef(null);

            const setupHost = async () => {
                try {
                    // Host always needs camera
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    streamRef.current = stream;
                    if (localVideoRef.current) {
                        localVideoRef.current.srcObject = stream;
                    }

                    const peer = new Peer('host-id');
                    
                    peer.on('open', (id) => {
                        setStatus('Host ready for connections');
                        peerRef.current = peer;
                    });

                    peer.on('connection', (conn) => {
                        setStatus('Viewer connected!');
                        setIsConnected(true);
                    });

                    peer.on('call', (call) => {
                        call.answer(stream);
                        setStatus('Video call started');
                        
                        call.on('stream', (remoteStream) => {
                            setStatus('Received viewer stream');
                        });
                    });

                } catch (err) {
                    setStatus('Error: ' + err.message);
                }
            };

            const setupViewer = async () => {
                try {
                    let stream = null;
                    if (useCamera) {
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true
                        });
                        if (localVideoRef.current) {
                            localVideoRef.current.srcObject = stream;
                        }
                    }
                    
                    const peer = new Peer();
                    streamRef.current = stream;
                    
                    peer.on('open', (id) => {
                        setStatus('Ready to connect to host');
                        peerRef.current = peer;
                    });

                } catch (err) {
                    setStatus('Error: ' + err.message);
                }
            };

            React.useEffect(() => {
                if (isHost) {
                    setupHost();
                } else {
                    setupViewer();
                }

                return () => {
                    if (streamRef.current) {
                        streamRef.current.getTracks().forEach(track => track.stop());
                    }
                    if (peerRef.current) {
                        peerRef.current.destroy();
                    }
                };
            }, [isHost, useCamera]);

            const connectToHost = () => {
                if (!peerRef.current) {
                    setStatus('Not ready to connect');
                    return;
                }

                // First establish data connection
                const conn = peerRef.current.connect('host-id');
                conn.on('open', () => {
                    setStatus('Connected to host!');
                    setIsConnected(true);

                    // Then establish video call if camera is enabled
                    if (useCamera && streamRef.current) {
                        const call = peerRef.current.call('host-id', streamRef.current);
                        call.on('stream', (remoteStream) => {
                            if (remoteVideoRef.current) {
                                remoteVideoRef.current.srcObject = remoteStream;
                            }
                        });
                    } else {
                        // Just receive the host's stream without sending one back
                        const call = peerRef.current.call('host-id', new MediaStream());
                        call.on('stream', (remoteStream) => {
                            if (remoteVideoRef.current) {
                                remoteVideoRef.current.srcObject = remoteStream;
                            }
                        });
                    }
                });
            };

            const toggleRole = () => {
                setIsHost(!isHost);
                setIsConnected(false);
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
                if (peerRef.current) {
                    peerRef.current.destroy();
                }
            };

            return (
                <div className="container">
                    <div className="role-selector">
                        <button onClick={toggleRole} disabled={isConnected}>
                            {isHost ? 'Switch to Viewer' : 'Switch to Host'}
                        </button>
                        
                        {!isHost && (
                            <label>
                                <input
                                    type="checkbox"
                                    checked={useCamera}
                                    onChange={(e) => setUseCamera(e.target.checked)}
                                    disabled={isConnected}
                                /> Use Camera
                            </label>
                        )}
                    </div>

                    <div className="status">Status: {status}</div>

                    {!isHost && !isConnected && (
                        <button onClick={connectToHost}>
                            Connect to Host
                        </button>
                    )}

                    {isHost && (
                        <div className="video-container">
                            <video
                                ref={localVideoRef}
                                autoPlay
                                playsInline
                                muted
                            />
                        </div>
                    )}

                    {(!isHost || useCamera) && (
                        <div className="remote-video">
                            <video
                                ref={remoteVideoRef}
                                autoPlay
                                playsInline
                                className="remote-video"
                            />
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
