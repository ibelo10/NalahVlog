<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chat</title>
    <!-- Load dependencies from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.1/peerjs.min.js"></script>
    <style>
        /* ... (previous styles remain the same) ... */
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Constants
        const STATUS_MESSAGES = {
            ROOM_CREATED: 'Room created! Share the room ID with others.',
            ROOM_JOINED: 'Successfully joined room',
            MEDIA_ERROR: 'Error accessing camera/microphone',
            PEER_CONNECTED: 'Peer connected!',
            PEER_DISCONNECTED: 'Peer disconnected',
        };

        // Custom Hook for Media Stream
        const useMediaStream = () => {
            const [stream, setStream] = React.useState(null);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                async function setupMedia() {
                    try {
                        const mediaStream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true
                        });
                        setStream(mediaStream);
                    } catch (err) {
                        setError(err.message);
                    }
                }
                setupMedia();
                return () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            return { stream, error };
        };

        // Main App Component
        const App = () => {
            const [roomId, setRoomId] = React.useState('');
            const [peer, setPeer] = React.useState(null);
            const [remotePeerId, setRemotePeerId] = React.useState(null);
            const [status, setStatus] = React.useState('');
            const [fullscreenVideo, setFullscreenVideo] = React.useState(null);
            const [isMuted, setIsMuted] = React.useState(false);
            const [isVideoOff, setIsVideoOff] = React.useState(false);
            const [remoteStream, setRemoteStream] = React.useState(null);

            const { stream: localStream, error: mediaError } = useMediaStream();
            const localVideoRef = React.useRef();
            const remoteVideoRef = React.useRef();

            const showStatus = (message) => {
                setStatus(message);
                setTimeout(() => setStatus(''), 3000);
            };

            React.useEffect(() => {
                if (localStream && localVideoRef.current) {
                    localVideoRef.current.srcObject = localStream;
                }
            }, [localStream]);

            React.useEffect(() => {
                if (remoteStream && remoteVideoRef.current) {
                    remoteVideoRef.current.srcObject = remoteStream;
                }
            }, [remoteStream]);

            React.useEffect(() => {
                if (localStream) {
                    const newPeer = new Peer();
                    
                    newPeer.on('open', (id) => {
                        setPeer(newPeer);
                        setRoomId(id);
                    });

                    newPeer.on('call', (call) => {
                        call.answer(localStream);
                        call.on('stream', (remoteStream) => {
                            setRemoteStream(remoteStream);
                            showStatus(STATUS_MESSAGES.PEER_CONNECTED);
                        });
                    });

                    return () => {
                        newPeer.destroy();
                    };
                }
            }, [localStream]);

            const connectToPeer = (peerId) => {
                if (!peer || !localStream) return;

                const call = peer.call(peerId, localStream);
                call.on('stream', (remoteStream) => {
                    setRemoteStream(remoteStream);
                    setRemotePeerId(peerId);
                    showStatus(STATUS_MESSAGES.PEER_CONNECTED);
                });
            };

            const toggleFullscreen = (videoType) => {
                if (fullscreenVideo === videoType) {
                    setFullscreenVideo(null);
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                } else {
                    setFullscreenVideo(videoType);
                    const element = videoType === 'local' ? 
                        localVideoRef.current : remoteVideoRef.current;
                    if (element.requestFullscreen) {
                        element.requestFullscreen();
                    }
                }
            };

            const toggleMute = () => {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    audioTrack.enabled = !audioTrack.enabled;
                    setIsMuted(!audioTrack.enabled);
                }
            };

            const toggleVideo = () => {
                if (localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    videoTrack.enabled = !videoTrack.enabled;
                    setIsVideoOff(!videoTrack.enabled);
                }
            };

            if (mediaError) {
                return <div className="error-message">{STATUS_MESSAGES.MEDIA_ERROR}</div>;
            }

            return (
                <div className="container">
                    {status && <div className="status">{status}</div>}
                    
                    <div className="room-controls">
                        <input
                            type="text"
                            className="room-input"
                            placeholder={peer ? "Your Room ID: " + roomId : "Loading..."}
                            disabled
                        />
                        <input
                            type="text"
                            className="room-input"
                            placeholder="Enter Peer Room ID to join"
                            onChange={(e) => setRemotePeerId(e.target.value)}
                        />
                        <button 
                            className="room-btn"
                            onClick={() => connectToPeer(remotePeerId)}
                            disabled={!peer || !remotePeerId}
                        >
                            Connect to Peer
                        </button>
                    </div>

                    <div className="video-grid">
                        <div className={`video-container ${fullscreenVideo === 'local' ? 'fullscreen' : ''}`}>
                            <video
                                ref={localVideoRef}
                                autoPlay
                                playsInline
                                muted
                                className="local-video"
                            />
                            <div className="controls">
                                <button 
                                    className={`control-btn ${isMuted ? 'off' : ''}`}
                                    onClick={toggleMute}
                                >
                                    {isMuted ? 'ðŸ”‡' : 'ðŸŽ¤'}
                                </button>
                                <button 
                                    className={`control-btn ${isVideoOff ? 'off' : ''}`}
                                    onClick={toggleVideo}
                                >
                                    {isVideoOff ? 'ðŸ“µ' : 'ðŸ“¹'}
                                </button>
                                <button 
                                    className="control-btn"
                                    onClick={() => toggleFullscreen('local')}
                                >
                                    {fullscreenVideo === 'local' ? 'â¤“' : 'â¤¢'}
                                </button>
                            </div>
                        </div>
                        
                        <div className={`video-container ${fullscreenVideo === 'remote' ? 'fullscreen' : ''}`}>
                            <video
                                ref={remoteVideoRef}
                                autoPlay
                                playsInline
                            />
                            {remoteStream && (
                                <button 
                                    className="control-btn fullscreen-btn"
                                    onClick={() => toggleFullscreen('remote')}
                                >
                                    {fullscreenVideo === 'remote' ? 'â¤“' : 'â¤¢'}
                                </button>
                            )}
                        </div>
                    </div>

                    {remoteStream && (
                        <div className="tip-section">
                            <h2>Send a Tip</h2>
                            <div className="tip-buttons">
                                {[5, 10, 20, 50].map(amount => (
                                    <button 
                                        key={amount}
                                        className="tip-btn"
                                        onClick={() => showStatus(`Tip of $${amount} sent!`)}
                                    >
                                        ${amount}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
